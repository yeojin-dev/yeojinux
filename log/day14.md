# GDT, IDT 테이블, TSS 세그먼트를 추가해 인터럽트에 대비하자

## 인터럽트와 예외

### 인터럽트와 예외의 차이점

* 인터럽트와 예외의 공통점은 코드 수행 도중에 발생하거나 프로세서에 의해 처리가 필요한 일종의 이벤트라는 점
    * 차이점 : 인터럽트는 키보드, 마우스, HDD와 같은 외부 디바이스에 의해 발생하여 프로세서에 전달되는 이벤트인 것에 반해 예외는 프로세서가 코드를 수행하는 도중에 페이지 폴트, 잘못된 명령과 같은 오류 발견 시 발생

* 예외 핸들러 : 인터럽트, 예외 이벤트에 대해 이벤트마다 필요한 특수 처리 함수로 인터럽트/예외 처리 후 발생 시점으로 복귀하도록 상태를 저장/복구하는 역할도 같이 수행해야만 함

### IDT와 IDT 게이트 디스크립터

* 프로세서는 외부 인터럽트나 소프트웨어 인터럽트가 발생했을 때 벡터 테이블의 인덱스에 해당하는 어드레스로 이동하여 처리 함수를 수행
    * 벡터 테이블을 각 운영 모드마다 존재 : 리얼 모드의 벡터 테이블은 `세그먼트:어드레스`의 형태로 어드레스 0x0000:0x0000에 위치하고 보호 모드, IA-32e 모드에서는 IDT라고 불리는 특수 형태의 벡터 테이블 사용

* IDT : IDT 게이트 디스크립터로 구성된 테이블이며 IDTR 레지스터를 통해 프로세서에 IDT 테이블 정보 설정
    * IDT 테이블은 최대 256개의 엔트리를 포함할 수 있고 IDT 게이트 디스크립터는 16바이트를 차지함

![IDT Gate Descriptor](https://image.slideserve.com/397411/slide24-l.jpg)

* IDT Gate Descriptor 필드의 의미

|필드|설명|
|---|---|
|핸들러 오프셋|인터럽트 또는 예외 핸들러의 엔트리 포인트, 64비트 크기|
|세그먼트 셀렉터|인터럽트 또는 예외 핸들러 수행 시 사용할 코드 세그먼트 디스크립터|
|IST|인터럽트나 예외 발생 시, 사용할 스택 어드레스(Top), 0이 아닌 값으로 설정하면 인터럽트 발생 시 강제로 스택을 교환함(이후 IST 섹션 참조)|
|타입|IDT 게이트의 종류(0110 - 인터럽트 게이트, 0111 - 트랩 게이트), 인터럽트 게이트로 설정하면 핸들러를 수행하는 동안 인터럽트가 발생하지 못 하며, 트랩 게이트로 설정하면 다른 인터럽트 발생 가능|
|DPL|Descriptor Privilege Level의 약자로 해당 디스크립터를 사용하는 데 필요한 권한을 의미, 0(Highest)~3(Lowest)의 범위를 가짐, CPL, RPL과 조합되어 접근 권한을 제한하는 데 사용|
|P|Present의 의미로 현재 디스크립터가 유효한 디스크립터인지 표시, 1로 설정하면 유효한 디스크립터임을 나타내며, 0으로 설정하면 유효하지 않은 디스크립터임을 나타냄|

* 세그먼트 셀렉터 : 이 셀렉터는 인터럽트 또는 예외 핸들러가 수행될 때 코드 세그먼트를 대체하며 핸들러 함수를 수행하는 데 충분한 권한으로 상승시키는 역할
    * 유저 레벨의 애플리케이션 코드를 실행할 때 인터럽트/예외 발생할 경우 권한 문제를 해결하기 위함

* 인터럽트 게이트 : 핸들러를 수행하는 동안 다른 인터럽트 발생하지 않음
    * MINT64에서는 인터럽트 게이트 사용

* IST(Interrupt Stack Table) : 인터럽트나 예외가 발생했을 때 별도의 스택 공간을 할당
    * 핸들러 수행 도중 오버플로우 방지하기 위함

### 인터럽트와 예외의 종류

* x86 프로세서는 IDT 테이블의 상위 32개 디스크립터를 예약해서 예외처리에 사용(실제 사용하는 20개이며 12개는 나중을 위해 예약)
    * 나머지 224개를 OS가 임의로 사용할 수 있음 : 인터럽트 처리와 애플리케이션 시스템 콜 용도로 사용함

* 프로세서의 20개 예외는 Faults, Traps, Aborts 3가지로 분류

1. Faults : 문제가 발생했으나 해당 코드의 문제를 수정하면 정상적으로 실행 가능한 예외
    * Fault 발생하면 복귀할 어드레스는 Fault 발생한 코드를 가리키며 핸들러의 실행이 완료된 후 해당 코드부터 다시 실행

2. Traps : Trap을 유발하는 명령어를 실행했을 때 발생
    * 디버깅과 관련이 있으며 핸들러 실행 후 해당 코드의 다음 코드부터 실행

3. Aborts : 심각한 문제가 발생하여 문제가 발생한 정확한 어드레스를 찾을 수 없으며 더 이상 코드를 수행할 수 없음
    * 시스템 오동작 또는 리부팅

![보호 모드, IA-32e 모드의 예외와 인터럽트 목록](https://i.stack.imgur.com/HayQE.png)

* NMI 인터럽트 : 프로세서에 연결된 Nonmaskable Interrupt Pin)으로 전달된 인터럽트로 프로세서 외부에서 심각한 장애 발생 시 발생

### PC 인터럽트의 종류와 원인

* PIC(Programmable Interrupt Controller) 컨트롤러를 사용해서 외부 인터럽트 관리

* PIC는 8개의 핀이 있으며 과거의 PC는 컨트롤러 2개를 마스터-슬레이브 방식으로 연결해 사용

![PIC](https://www.helpwithpcs.com/upgrading/irq-settings/viewing-irq-settings.jpg)
