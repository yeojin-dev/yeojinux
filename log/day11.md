# 페이징 기능을 활성화하여 64비트 전환을 준비하자

## 선형 주소와 4단계 페이징 기법

![IA-32e 페이징](https://blog.quarkslab.com/resources/2016-07-12_xsa-148/images/paging.png)

* 위 그림에서는 Table + Offset
* 책에는 63~48비트 영역이 부호 확장으로 존재

* 페이징에 사용되는 각 테이블은 512(2^9)개의 엔트리로 구성되며, 다음 레벨에서 사용할 테이블의 기준 주소를 포함
    * 가장 마지막 레벨인 페이지 디렉터리의 엔트리는 2MB 페이지의 기준 주소를 포함

* 선형 주소를 물리 주소로 변환하기
    1. CR3 레지스터에 설정된 PML4(Page Map Level 4) 테이블의 기준 주소(40비트)로부터 PML4 엔트리 조회
    2. PML4 엔트리의 디렉터리 포인터 테이블의 기준 주소(40비트)로부터 디렉터리 엔트리 조회
    3. 디렉터리 엔트리 테이블의 기준 주소(19비트)로부터 페이지 기준 주소 조회
    4. 페이지 기준 주소(물리 주소)에서 오프셋(21비트)만큼의 위치가 조회할 물리 주소

![PML4 테이블 엔트리](https://camo.githubusercontent.com/b3453a4fa1d8d04657cafe9bb036cd5d599f298e/68747470733a2f2f692e696d6775722e636f6d2f5058466b6745572e706e67)
![페이지 디렉터리 포인터 테이블 엔트리](https://camo.githubusercontent.com/90e4ef56164159e97e185b79e87f92728c9102ba/68747470733a2f2f692e696d6775722e636f6d2f36584b484a796b2e706e67)
![페이지 디렉터리 엔트리](https://camo.githubusercontent.com/2c972366091df3be8d1d45ba692d449471beeb06/68747470733a2f2f692e696d6775722e636f6d2f3857476c784e442e706e67)

* 이미지 오타 : PWD -> PWT

* 페이지 테이블을 구성하는 엔트리의 각 필드와 의미

|필드|설명|
|---|---|
|EXB|Execute-Disable 비트의 약자로 관련된 페이지를 데이터 전용으로 설정하는 것을 의미, 1로 설정하면 해당 페이지는 데이터 전용으로 설정되며 해당 영역에서 코드를 실행하면 페이지 폴트 예외가 발생함, 0으로 설정하면 제약 사항 없음, IA32_EFER 레지스터의 NXE 비트를 1로 설정할 경우 유효함|
|Avail|Available의 약자로 OS에서 임의의 용도로 사용할 수 있는 영역을 의미, 임의의 용도로 사용할 수 있음|
|Base Address|다음 레벨 테이블 또는 페이지의 기준 주소를 의미|
|A|Accessed의 약자로 해당 페이지가 접근(읽기 또는 쓰기)되었음을 의미, 프로세서가 페이지를 검사하여 접근이 있으면 해당 비트를 설정함, 1로 설정되면 접근되었음을 나타내고 0으로 설정되면 접근되지 않았음을 나타냄|
|PCD|Page-level Cache Disable의 약자로 해당 페이지의 캐시 활성화 여부를 의미, CR0 레지스터의 CD 비트가 1로 설정되어 전체 캐시가 비활성화된 경우, PCD 비트는 무시됨, 1로 설정하면 해당 페이지의 캐시를 비활성화하며, 0으로 설정하면 페이지의 캐시를 활성화함|
|PWT|Page-level Write Through의 약자로 해당 페이지의 캐시 정책을 의미, PCD와 마찬가지로 CR0 레지스터의 CD 비트가 1로 설정되어 전체 캐시가 비활성화된 경우 PWT 비트는 무시됨, 1로 설정하면 해당 페이지는 Write-Through 정책이 적용되며 0으로 설정하면 Write-Back 정책이 적용됨|
|U/S|User/Supervisor의 약자로 해당 페이지의 권한을 의미, 1로 설정하면 유저 레벨 권한(Ring 3)임을 나타내며, 모든 레벨에서 해당 페이지에 접근할 수 있음, 0으로 설정하면 특권 레벨 권한(Ring 0~2)을 나타내며, 유저 레벨에서 해당 페이지에 접근하면 페이지 폴트 예외가 발생함|
|R/W|Read/Write의 약자로 해당 페이지의 읽기/쓰기 정책을 의미, 1로 설정하면 읽기/쓰기 모두 가능, 0으로 설정하면 읽기만 가능하며 쓰기를 시도하면 페이지 폴트 예외 발생|
|P|Present의 약자로 해당 엔트리가 유효함을 의미, 1로 설정하면 유효함을 나타내며, 0으로 설정하면 유효하지 않음을 나타냄, 0으로 설정된 페이지에 접근하면 페이지 폴트 예외 발생|
|PAT|Page Attribute Table Index의 약자로 PAT 선택에 사용되는 최상위 비트를 의미, 프로세서가 PAT를 지원할 경우 PAT, PCD, PWT 3비트를 사용하여 PAT를 선택, 프로세서가 PAT를 지원하지 않으면 0으로 예약됨|
|G|Global의 약자로 CR3 레지스터 값이 바뀌더라도 해당 페이지를 페이지 테이블 캐시인 TLB(Transaction Lookaside Buffer)에서 교체하지 않음을 의미, CR4 레지스터의 PGE 비트를 1로 설정할 때만 유효함, 1로 설정하면 CR3 레지스터 교체 싣에 해당 페이지를 TLB에서 교체하지 않으며, 0으로 설정하면 TLB에서 교체함|
|PS|Page Size의 약자로 페이지의 크기를 의미, 1로 설정했을 때 CR4 레지스터의 PAE 비트가 0이면 4MB 페이지를 나타내며 PAE 비트가 1이면 2MB 페이지를 나타냄, 0으로 설정하면 4KB 페이지를 나타냄|
|D|Dirty의 약자로 페이지에 쓰기가 수행되었음을 의미, A 비트와 마찬가지로 프로세서가 해당 페이지를 감시하여 해당 비트를 설정함, 1로 설정되면 쓰기가 수행되었음을 나타내고 0으로 설정되면 쓰기가 수행되지 않았음을 나타냄|

* MINT64 OS를 실행하는 데 필요한 페이지의 역할
    1. 선형 주소와 물리 주소를 1:1로 매핑하여 직관적인 어드레스 변환을 수행해야 함
    2. 2MB 페이지를 사용하여 최대 64GB의 물리 메모리를 매핑해야 함
    3. 물리 메모리 전체 영역에 대해 캐시를 활성화하여 수행 속도 향상시켜야 함
    4. 위 기능 외 다른 기능은 사용하지 않음

## 페이지 테이블 구성과 공간 할당

### 64GB의 물리 메모리 관리를 위한 메모리 계산

* 페이지 디렉터리는 8바이트의 엔트리 512개(2^9)로 구성되어 있으며 각 엔트리는 2MB
    * 페이지 디렉터리 하나는 1GB 메모리 영역을 관리하며 자체의 크기는 4KB
    * 64GB 메모리 영역을 관리하려면 64개의 페이지 디렉터리가 필요하며 필요한 크기는 256KB

* 페이지 디렉터리 포인터 테이블은 8바이트의 엔트리 512개(2^9)로 구성되어 있음
    * 1개만 있으면 되기 때문에 필요한 크기는 4KB

* PML4 테이블도 8바이트의 엔트리 512개
    * 1개만 있으면 되기 때문에 필요한 크기는 4KB
    * PML4 테이블의 엔트리를 모두 사용하면 265TB까지 가능

* MINT64 OS에서 메모리 관리를 위해 필요한 메모리 공간은 264KB

### 페이지 테이블을 위한 공간 할당

* 0x100000(1MB) ~ 0x200000(2MB) 영역이 IA-32e 모드용 커널 자료구조 영역으로 사용하며 이 중 가장 앞부분에 페이지 테이블 사용
    * 0x100000 ~ 0x142000 영역을 PML4 테이블, 페이지 디렉터리 포인터 테이블, 페이지 디렉터리 순서로 저장

### 공통 속성 필드 설정

#### PCD 필드와 PWT 필드

* 속도 향상을 위해 캐시를 사용하며 Write-Back 방식 사용
    * PCD = 0, PWT = 0

#### U/S 필드와 R/W 필드

* 현재는 커널만 존재하고 유저 레벨 애플리케이션이 없기 때문에 모든 페이지를 읽기/쓰기 가능하도록 설정
    * U/S = 0, R/W = 1

#### EXB 필드, A 필드, P 필드, Avail 필드

* EXB 필드는 사용하지 않으므로 0
* 코드 실행 도중에 특정 페이지에 접근했는지 여부도 참조하지 않으므로 A = 0
* P 필드는 해당 엔트리가 유효하다는 것을 나타내는 필드이므로 다른 필드와 달리 반드시 1로 설정

### 페이지 디렉터리 엔트링용 속성 필드 설정

* PAT 필드는 사용하지 않으므로 0
* 태스크 별로 페이지 매핑을 따로 구성하지 않으므로 G 필드 0으로 설정
* D 필드 역시 참조하지 않으르몰 0
