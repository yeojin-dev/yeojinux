# 키보드 디바이스 드라이버를 추가하자

## 키보드 컨트롤러의 구조와 기능

### 키보드 컨트롤러, I/O 포트, 레지스터

* 키보드 컨트롤러는 PC 내부 버스(BUS)와 포드 I/O 방식으로 연결되어 있으며, 포트 어드레스는 0x60, 0x64를 사용
    * 할당된 포트는 2개지만 포트에서 데이터를 일글 때와 쓸 때 접근하는 레지스터가 다르기 때문에 레지스터 입장에서는 4개가 연결된 것과 같음

![키보드와 마우스, 키보드 컨트롤러, PC의 관계](https://img1.daumcdn.net/thumb/R800x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F2539BE455868ECCA38)

* I/O 포트와 키보드 컨트롤러 레지스터의 관계

|포트 번호|읽기/쓰기|레지스터 이름|설명|
|------|-------|----------|---|
|0x64|쓰기|컨트롤 레지스터|키보드 컨트롤러를 제어하는 레지스터|
|0x64|읽기|상태 레지스터|키보드 컨트롤러의 상태를 나타내는 레지스터|
|0x60|쓰기|입력 버퍼|프로세서가 키보드나 마우스로 보내는 커맨드 또는 데이터를 저장하는 레지스터|
|0x60|읽기|출력 버퍼|키보드나 마우스가 프로세서로 보내는 데이터를 저장하는 레지스터|

* 각 레지스터는 1바이트 크기

#### 상태 레지스터의 비트 구성과 의미

|비트|필드|설명|
|---|---|---|
|7|PARE|Parity Error의 약자로 키보드나 마우스로 온 마지막 데이터에 패리티 에러가 발생했음을 의미, 1로 설정되면 패리티 에러가 발생했음을 나타내며 0으로 설정되면 에러가 발생하지 않았음을 나타냄|
|6|TIM|General Time-Out의 약자로 키보드 또는 마우스가 정해진 시간에 응답하지 않았음을 의미, 1로 설정되면 타임 아웃이 발생했음을 나타내며 0으로 설정되면 발생하지 않았음을 의미|
|5|AUXB|출력 버퍼에 보조 디바이스(Auxiliary Device=마우스)의 데이터가 있음을 의미, 1로 설정되면 마우스 데이터임을 나타내며 0으로 나타내면 키보드 데이터임을 나타냄|
|4|KEYL|Keyboard Lock Status의 약자로 키보드가 잠겼는지(Lock) 여부를 설정, 1로 설정되면 잠겼음을 나타내며 0으로 설정되면 잠기지 않았음을 나타냄|
|3|C/D|Command/Data의 약자로 마지막으로 송신된 데이터의 종류를 의미, 1로 설정되면 마지막으로 송수신된 데이터가 커맨드(포트 Ox64)임을 나타내고, 0으로 설정되면 데이터(포트 0x60)임을 나타냄|
|2|SYSF|System Flag의 약자로 Self-Test가 정상적으로 끝났는지 여부를 의미, 1로 설정되면 Self-Test가 성공적으로 끝나서 사용 가능함을 나타내며, 0으로 설정되면 Power-On-Reset이 진행중임을 나타냄|
|1|INPB|Input Buffer State의 약자로 입력 버퍼에 프로세서가 쓴 데이터가 남아있는지 여부를 의미, 1로 설정되면 키보드 컨트롤러가 아직 입력 버퍼의 데이터를 가져가지 않았음을 나타내며 0으로 설정되면 컨트롤러가 데이터를 가져가서 키보드나 마우스로 전송하여 입력 버퍼가 비었음을 나타냄|
|0|OUTB|Output Buffer State의 약자로 출력 버퍼에 키보드 컨트롤러가 보낸 데이터가 남아있는지 여부를 의미, 1로 설정되면 키보드 컨트롤러가 키보드 또는 마우스에서 수신한 데이터가 출력 버퍼에 있음을 나타내며, 0으로 설정되면 프로세서가 데이터를 가져가서 출력 버퍼가 비어있음을 나타냄|

* 키보드 컨트롤러가 키 값을 얻는 것만 생각하면 상태 레지스터를 읽어서 OUTB 비트가 1인지 검사하고 나서 출력 버퍼 레지스터를 읽은 것만으로 충분하지만 키보드 컨트롤러를 제어할 때는 키보드 컨트롤러 커맨드로 제어

#### 키보드 컨트롤러 커맨드

|키보드 컨트롤러 커맨드|설명|
|----------------|---|
|0x20|키보드 컨트롤러의 커맨드 바이트를 출력 버퍼(포트 0x60)로 복사|
|0x60|입력 버퍼(포트 0x60)에 쓴 값을 키보드 컨트롤러의 커맨드 바이트로 복사, 비트 1을 1로 설정하면 마우스 인터럽트 활성화, 비트 0을 1로 설정하면 키보드 인터럽트 활성화|
|0xA7|마우스 디바이스 비활성화|
|0xA8|마우스 디바이스 활성화|
|0xAD|키보드 디바이스 비활성화|
|0xAE|키보드 디바이스 활성화|
|0xD0|키보드 컨트롤러의 출력 포트 값을 출력 버퍼(포트 0x60)로 복사|
|0xD1|입력 버퍼(0x60)에 쓴 값을 키보드 컨트롤러의 출력 포트로 복사, 비트 1을 1로 설정하면 A20 게이트 활성화, 비트 0을 0으로 설정하면 프로세서 리셋(PC 재부팅)|
|0xD4|입력 버퍼(포트 0x60)에 쓴 값을 마우스 디바이스로 송신|
